import { BASE_URL } from "@template/configuration";
import { allPosts } from "@template/contentlayer";
import { ImageResponse } from "next/server";

export const runtime = "edge";

export const alt = `${BASE_URL} blog post`;
export const size = {
  width: 1200,
  height: 630,
};

async function getPostFromParams(slug: string) {
  const post = allPosts.find((post) => post.slug === slug);

  if (!post) {
    return null;
  }

  return post;
}

// Font
const interBold = fetch(new URL("../../../../public/fonts/Inter-Bold.ttf", import.meta.url)).then((res) =>
  res.arrayBuffer(),
);
const interRegular = fetch(new URL("../../../../public/fonts/Inter-Regular.ttf", import.meta.url)).then((res) =>
  res.arrayBuffer(),
);

export default async function Image({ params }: { params: { slug: string } }) {
  try {
    const post = await getPostFromParams(params.slug);

    if (!post) {
      return null;
    }

    const fontRegular = await interRegular;
    const fontBold = await interBold;

    const mode = "dark";
    const paint = "#fff";

    const heading = post.title.length > 140 ? `${post.title.substring(0, 140)}...` : post.title;
    const fontSize = heading.length > 100 ? "70px" : "100px";

    return new ImageResponse(
      (
        <div
          tw="flex relative flex-col p-12 w-full h-full items-start"
          style={{
            color: paint,
            background: mode === "dark" ? "linear-gradient(90deg, #000 0%, #111 100%)" : "white",
          }}
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="202" height="40" fill="none">
            <path
              fill={paint}
              fillRule="evenodd"
              d="M25.556 11.685A10 10 0 0 0 20 10V0A20 20 0 1 1 0 20h10a10 10 0 1 0 15.556-8.315Z"
              clipRule="evenodd"
            />
            <path
              fill={paint}
              fillRule="evenodd"
              d="M10 0A10 10 0 0 1 0 10v10A20 20 0 0 0 20 0H10Z"
              clipRule="evenodd"
            />
            <path
              fill={paint}
              d="M125.619 14.453h-4.852v15.412h4.852V14.453ZM121.307 11.567c.507.507 1.141.76 1.902.76.761 0 1.385-.253 1.871-.76.487-.529.73-1.163.73-1.903 0-.761-.243-1.396-.73-1.903-.486-.507-1.11-.761-1.871-.761-.761 0-1.395.254-1.902.761-.487.507-.73 1.142-.73 1.903 0 .74.243 1.374.73 1.903ZM51.156 29.865V7.475h4.98V25.49h9.925v4.376H51.156Z"
            />
            <path
              fill={paint}
              fillRule="evenodd"
              d="M75.027 30.214c-1.585 0-3.023-.35-4.313-1.047a8.144 8.144 0 0 1-3.012-2.918c-.74-1.226-1.11-2.6-1.11-4.122 0-1.522.37-2.886 1.11-4.091a7.98 7.98 0 0 1 3.013-2.854c1.268-.719 2.706-1.078 4.312-1.078 1.607 0 3.045.349 4.313 1.046a7.903 7.903 0 0 1 3.013 2.886c.74 1.205 1.11 2.569 1.11 4.09 0 1.523-.37 2.897-1.11 4.123a8.143 8.143 0 0 1-3.013 2.918c-1.268.698-2.706 1.047-4.313 1.047Zm0-4.408c.698 0 1.311-.148 1.84-.444.528-.317.93-.75 1.205-1.3.296-.571.444-1.216.444-1.935 0-.719-.148-1.343-.444-1.871a3.109 3.109 0 0 0-1.237-1.269c-.507-.317-1.11-.475-1.808-.475-.676 0-1.279.158-1.807.475a3.11 3.11 0 0 0-1.237 1.269c-.296.55-.444 1.184-.444 1.903 0 .697.148 1.332.444 1.902.296.55.708.983 1.237 1.3.528.297 1.13.445 1.807.445ZM87.306 35.89c1.29.592 2.78.888 4.471.888 1.65 0 3.119-.328 4.408-.983 1.29-.655 2.305-1.564 3.045-2.727.74-1.163 1.11-2.537 1.11-4.123V14.453h-4.757v1.035a5.127 5.127 0 0 0-1.205-.75c-.825-.402-1.766-.603-2.823-.603-1.416 0-2.674.339-3.774 1.015-1.1.655-1.966 1.565-2.6 2.727-.634 1.142-.951 2.432-.951 3.87 0 1.416.317 2.706.95 3.868a7.255 7.255 0 0 0 2.601 2.76c1.1.676 2.358 1.014 3.774 1.014 1.036 0 1.977-.2 2.823-.602.41-.195.78-.424 1.11-.688v.973c0 1.078-.35 1.913-1.047 2.505-.677.592-1.617.888-2.822.888-.973 0-1.808-.169-2.506-.507-.676-.338-1.29-.835-1.84-1.49l-2.98 2.98c.74 1.057 1.744 1.871 3.013 2.442Zm6.913-11.258c-.486.296-1.068.444-1.744.444-.677 0-1.269-.148-1.776-.444a3.129 3.129 0 0 1-1.142-1.205 3.592 3.592 0 0 1-.412-1.68c0-.635.137-1.206.412-1.713a3.06 3.06 0 0 1 1.174-1.205c.507-.296 1.088-.444 1.744-.444.676 0 1.258.148 1.744.444a2.85 2.85 0 0 1 1.142 1.205c.274.507.412 1.078.412 1.712 0 .635-.138 1.205-.412 1.713a2.9 2.9 0 0 1-1.142 1.173ZM110.551 30.214c-1.586 0-3.024-.35-4.313-1.047a8.141 8.141 0 0 1-3.013-2.918c-.74-1.226-1.11-2.6-1.11-4.122 0-1.522.37-2.886 1.11-4.091a7.978 7.978 0 0 1 3.013-2.854c1.268-.719 2.706-1.078 4.313-1.078 1.606 0 3.044.349 4.312 1.046a7.901 7.901 0 0 1 3.013 2.886c.74 1.205 1.11 2.569 1.11 4.09 0 1.523-.37 2.897-1.11 4.123a8.141 8.141 0 0 1-3.013 2.918c-1.268.698-2.706 1.047-4.312 1.047Zm0-4.408c.697 0 1.31-.148 1.839-.444.528-.317.93-.75 1.205-1.3.296-.571.444-1.216.444-1.935 0-.719-.148-1.343-.444-1.871a3.107 3.107 0 0 0-1.237-1.269c-.507-.317-1.11-.475-1.807-.475-.677 0-1.28.158-1.808.475a3.107 3.107 0 0 0-1.237 1.269c-.296.55-.444 1.184-.444 1.903 0 .697.148 1.332.444 1.902.296.55.708.983 1.237 1.3.528.297 1.131.445 1.808.445ZM137.281 30.182c-1.035 0-1.987-.2-2.854-.603a6.063 6.063 0 0 1-1.236-.757v7.544h-4.789V14.453h4.852v1.063a6 6 0 0 1 1.173-.746c.867-.423 1.819-.635 2.854-.635 1.459 0 2.749.35 3.869 1.047a7.214 7.214 0 0 1 2.664 2.854c.656 1.205.983 2.58.983 4.123 0 1.543-.327 2.917-.983 4.122a7.215 7.215 0 0 1-2.664 2.854c-1.12.698-2.41 1.047-3.869 1.047Zm-.887-4.376c.697 0 1.3-.159 1.807-.476.529-.317.941-.75 1.237-1.3.296-.55.444-1.174.444-1.871 0-.72-.148-1.353-.444-1.903a3.107 3.107 0 0 0-1.237-1.269c-.507-.317-1.099-.475-1.776-.475-.676 0-1.279.158-1.807.475a3.168 3.168 0 0 0-1.205 1.269c-.296.55-.444 1.184-.444 1.903 0 .697.137 1.321.412 1.87.296.55.708.984 1.237 1.3.528.318 1.12.477 1.776.477Z"
              clipRule="evenodd"
            />
            <path
              fill={paint}
              d="M149.546 29.896c.888.233 1.786.35 2.695.35 1.924 0 3.446-.445 4.567-1.333 1.141-.887 1.712-2.082 1.712-3.583 0-.973-.179-1.755-.539-2.347a4.194 4.194 0 0 0-1.395-1.459 8.33 8.33 0 0 0-1.808-.856 27.898 27.898 0 0 0-1.807-.539c-.571-.148-1.036-.317-1.396-.507-.359-.19-.539-.444-.539-.762 0-.296.138-.517.412-.665.275-.17.687-.254 1.237-.254.571 0 1.152.116 1.744.349.613.232 1.163.634 1.649 1.205l2.759-2.79c-.697-.889-1.606-1.555-2.727-1.999-1.099-.465-2.304-.697-3.615-.697-1.247 0-2.336.21-3.266.634-.931.423-1.65 1.004-2.157 1.744-.507.719-.761 1.575-.761 2.569 0 .93.18 1.702.539 2.315a4.01 4.01 0 0 0 1.395 1.395 8.103 8.103 0 0 0 1.808.793c.634.19 1.237.37 1.808.539.57.148 1.036.328 1.395.54.381.19.571.475.571.855 0 .296-.159.529-.476.698-.296.17-.729.254-1.3.254a5.78 5.78 0 0 1-2.283-.444 5.56 5.56 0 0 1-1.808-1.3l-2.759 2.79a8.61 8.61 0 0 0 1.903 1.522c.761.423 1.575.75 2.442.983ZM167.368 30.214c-1.416 0-2.674-.286-3.773-.857a6.622 6.622 0 0 1-2.537-2.41c-.614-1.036-.92-2.22-.92-3.552v-8.942h4.852v8.879c0 .528.084.983.254 1.364.19.38.465.676.824.888.36.211.793.317 1.3.317.719 0 1.29-.222 1.713-.666.423-.465.634-1.1.634-1.903v-8.88h4.852v8.912c0 1.353-.306 2.547-.92 3.583a6.622 6.622 0 0 1-2.537 2.41c-1.078.571-2.325.857-3.742.857ZM181.831 14.453h-4.852v15.412h4.852v-9.007c0-.528.106-.972.317-1.332.233-.359.54-.634.92-.824a2.632 2.632 0 0 1 1.3-.317c.698 0 1.279.222 1.744.666.487.423.73 1.025.73 1.807v9.007h4.852v-9.007c0-.528.106-.972.317-1.332.233-.359.539-.634.92-.824a2.63 2.63 0 0 1 1.3-.317c.698 0 1.279.222 1.744.666.486.423.729 1.025.729 1.807v9.007h4.853v-9.546c0-1.29-.275-2.389-.825-3.298a5.297 5.297 0 0 0-2.188-2.125c-.909-.507-1.956-.76-3.14-.76-1.205 0-2.294.264-3.266.792a5.924 5.924 0 0 0-1.657 1.304 5.392 5.392 0 0 0-1.61-1.367c-.845-.486-1.807-.73-2.885-.73-1.142 0-2.167.244-3.076.73a5.314 5.314 0 0 0-1.079.727v-1.14Z"
            />
          </svg>
          <div tw="flex flex-col flex-1 py-10">
            <div
              tw="flex text-xl uppercase font-bold tracking-tight"
              style={{ fontFamily: "Inter", fontWeight: "normal" }}
            >
              {post.category}
            </div>
            <div
              tw="flex leading-[1.1] text-[80px] font-bold"
              style={{
                fontFamily: "Cal Sans",
                fontWeight: "bold",
                marginLeft: "-3px",
                fontSize,
              }}
            >
              {heading}
            </div>
          </div>
          <div tw="flex items-center w-full justify-between">
            <div tw="flex text-xl" style={{ fontFamily: "Inter", fontWeight: "normal" }}>
              {BASE_URL}
            </div>
            <div tw="flex items-center text-xl" style={{ fontFamily: "Inter", fontWeight: "normal" }}>
              <svg className="h-6 w-6" aria-hidden="true" fill={paint} viewBox="0 0 24 24">
                <path
                  fillRule="evenodd"
                  d="M10 0C4.477 0 0 4.484 0 10.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0110 4.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.203 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.942.359.31.678.921.678 1.856 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0020 10.017C20 4.484 15.522 0 10 0z"
                  clipRule="evenodd"
                />
              </svg>
              <div tw="flex ml-2">github.com/amosbastian/template</div>
            </div>
          </div>
        </div>
      ),
      {
        width: 1200,
        height: 630,
        fonts: [
          {
            name: "Inter",
            data: fontRegular,
            weight: 400,
            style: "normal",
          },
          {
            name: "Cal Sans",
            data: fontBold,
            weight: 700,
            style: "normal",
          },
        ],
      },
    );
  } catch (error) {
    return new Response(`Failed to generate image`, {
      status: 500,
    });
  }
}
